# Makefile for ft_transcendence
# Automated setup and deployment

.PHONY: help install setup vault-init start stop clean logs test

# Colors for output
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m # No Color

help: ## Show this help message
	@echo "$(GREEN)ft_transcendence - Makefile Commands$(NC)"
	@echo "======================================"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-15s$(NC) %s\n", $$1, $$2}'

install: ## Install all dependencies
	@echo "$(GREEN)ğŸ“¦ Installing dependencies...$(NC)"
	@cd backend && npm ci
	@cd frontend && npm install
	@echo "$(GREEN)âœ… Dependencies installed$(NC)"

setup: install ## Complete setup (install + docker + vault)
	@echo "$(GREEN)ğŸš€ Setting up ft_transcendence...$(NC)"
	@docker-compose up -d db vault
	@echo "$(YELLOW)â³ Waiting for services to start...$(NC)"
	@sleep 10
	@$(MAKE) vault-init
	@echo "$(GREEN)âœ… Setup complete!$(NC)"

vault-init: ## Initialize Vault with secrets
	@echo "$(GREEN)ğŸ” Initializing Vault secrets...$(NC)"
	@curl -s -X PUT -H "X-Vault-Token: myroot" \
		-d '{"data":{"username":"transcendence","password":"password123","host":"localhost","port":"5434","database":"transcendence"}}' \
		http://localhost:8200/v1/secret/data/database > /dev/null
	@curl -s -X PUT -H "X-Vault-Token: myroot" \
		-d '{"data":{"secret":"your-super-secret-jwt-key-for-development-only"}}' \
		http://localhost:8200/v1/secret/data/jwt > /dev/null
	@echo "$(GREEN)âœ… Vault secrets initialized$(NC)"

start: ## Start the complete application
	@echo "$(GREEN)ğŸš€ Starting ft_transcendence...$(NC)"
	@docker-compose up -d db vault
	@echo "$(YELLOW)â³ Waiting for database and vault...$(NC)"
	@sleep 5
	@$(MAKE) vault-init
	@echo "$(GREEN)ğŸŒ Starting frontend and backend...$(NC)"
	@npm run start:all

start-dev: setup start ## Complete setup and start (first time)

start-https: ## Start complete HTTPS site (production mode)
	@echo "$(GREEN)ğŸ” Starting ft_transcendence HTTPS site...$(NC)"
	@echo "$(YELLOW)ğŸ“‹ Configuration HTTPS:$(NC)"
	@echo "   - Frontend React/Vite servi via HTTPS"
	@echo "   - Backend API accessible via proxy HTTPS"
	@echo "   - Site HTTPS: https://localhost"
	@echo "   - Certificats SSL auto-signÃ©s"
	@echo ""
	@echo "$(GREEN)ğŸ“¦ Building frontend...$(NC)"
	@cd frontend && npm run build
	@echo "$(GREEN)ğŸ” Generating SSL certificates...$(NC)"
	@mkdir -p ssl
	@if [ ! -f "ssl/cert.pem" ]; then \
		openssl genrsa -out ssl/key.pem 2048; \
		openssl req -new -x509 -key ssl/key.pem -out ssl/cert.pem -days 365 \
			-subj "/C=FR/ST=France/L=Paris/O=42School/OU=ft_transcendence/CN=localhost" \
			-addext "subjectAltName=DNS:localhost,DNS:127.0.0.1,IP:127.0.0.1"; \
		chmod 600 ssl/key.pem; \
		chmod 644 ssl/cert.pem; \
		echo "$(GREEN)âœ… Certificats SSL gÃ©nÃ©rÃ©s$(NC)"; \
	else \
		echo "$(GREEN)âœ… Certificats SSL existants trouvÃ©s$(NC)"; \
	fi
	@echo "$(GREEN)ğŸ›‘ Stopping existing services...$(NC)"
	@docker-compose down 2>/dev/null || true
	@docker-compose -f docker-compose.secure.yml down 2>/dev/null || true
	@echo "$(GREEN)ğŸš€ Starting HTTPS services...$(NC)"
	@docker-compose -f docker-compose.secure.yml up --build -d
	@echo ""
	@echo "$(GREEN)âœ… ft_transcendence HTTPS site dÃ©ployÃ© avec succÃ¨s!$(NC)"
	@echo "======================================================"
	@echo "$(GREEN)ğŸŒ Site accessible sur: https://localhost$(NC)"
	@echo "$(YELLOW)âš ï¸  Acceptez l'exception de sÃ©curitÃ© pour le certificat auto-signÃ©$(NC)"
	@echo ""
	@echo "$(GREEN)ğŸ” Commandes utiles:$(NC)"
	@echo "   - Logs: make logs-https"
	@echo "   - ArrÃªt: make stop-https"
	@echo "   - Statut: make status-https"

stop: ## Stop all services
	@echo "$(YELLOW)ğŸ›‘ Stopping services...$(NC)"
	@docker-compose down
	@pkill -f "npm run start" || true
	@echo "$(GREEN)âœ… All services stopped$(NC)"

stop-https: ## Stop HTTPS services
	@echo "$(YELLOW)ğŸ›‘ Stopping HTTPS services...$(NC)"
	@docker-compose -f docker-compose.secure.yml down
	@echo "$(GREEN)âœ… HTTPS services stopped$(NC)"

clean: stop ## Stop and clean everything
	@echo "$(YELLOW)ğŸ§¹ Cleaning up...$(NC)"
	@docker-compose down -v --remove-orphans
	@docker system prune -f
	@echo "$(GREEN)âœ… Cleanup complete$(NC)"

logs: ## Show logs
	@echo "$(GREEN)ğŸ“‹ Services logs:$(NC)"
	@docker-compose logs

logs-db: ## Show database logs
	@docker-compose logs db

logs-vault: ## Show vault logs
	@docker-compose logs vault

logs-https: ## Show HTTPS services logs
	@echo "$(GREEN)ğŸ“‹ HTTPS Services logs:$(NC)"
	@docker-compose -f docker-compose.secure.yml logs

test: ## Run tests
	@echo "$(GREEN)ğŸ§ª Running tests...$(NC)"
	@npm run test:http

restart: stop start ## Restart all services

quick-restart: ## Quick restart (without reinstalling)
	@echo "$(YELLOW)ğŸ”„ Quick restart...$(NC)"
	-@pkill -f "node src/server.js" 2>/dev/null || true
	-@pkill -f "vite" 2>/dev/null || true
	-@pkill -f "concurrently" 2>/dev/null || true
	@sleep 2
	@docker-compose restart db vault
	@sleep 3
	@$(MAKE) vault-init
	@echo "$(GREEN)ğŸŒ Starting frontend and backend...$(NC)"
	@npm run start:all

status: ## Show services status
	@echo "$(GREEN)ğŸ“Š Services Status:$(NC)"
	@docker-compose ps
	@echo ""
	@echo "$(GREEN)ğŸ” Health Checks:$(NC)"
	@curl -s http://localhost:8200/v1/sys/health | grep -q "initialized.*true" && echo "$(GREEN)âœ… Vault: OK$(NC)" || echo "$(RED)âŒ Vault: Error$(NC)"
	@curl -s http://localhost:3000/healthz | grep -q "ok" && echo "$(GREEN)âœ… Backend: OK$(NC)" || echo "$(YELLOW)â³ Backend: Starting...$(NC)"
	@curl -s http://localhost:5173 > /dev/null && echo "$(GREEN)âœ… Frontend: OK$(NC)" || echo "$(YELLOW)â³ Frontend: Starting...$(NC)"

status-https: ## Show HTTPS services status
	@echo "$(GREEN)ğŸ“Š HTTPS Services Status:$(NC)"
	@docker-compose -f docker-compose.secure.yml ps
	@echo ""
	@echo "$(GREEN)ğŸ” HTTPS Health Checks:$(NC)"
	@curl -s -k https://localhost/api/healthz | grep -q "ok" && echo "$(GREEN)âœ… HTTPS Site: OK$(NC)" || echo "$(YELLOW)â³ HTTPS Site: Starting...$(NC)"
	@curl -s -k https://localhost > /dev/null && echo "$(GREEN)âœ… HTTPS Frontend: OK$(NC)" || echo "$(YELLOW)â³ HTTPS Frontend: Starting...$(NC)"

security-test: ## Test security features
	@echo "$(GREEN)ğŸ”’ Testing security features...$(NC)"
	@echo "Testing weak password rejection:"
	@curl -s -X POST http://localhost:3000/api/auth/register \
		-H "Content-Type: application/json" \
		-d '{"email":"test@test.com","password":"weak"}' | grep -q "Password" && echo "$(GREEN)âœ… Password validation working$(NC)" || echo "$(RED)âŒ Password validation failed$(NC)"

check-ssl: ## Check SSL certificates (if they exist)
	@echo "$(GREEN)ğŸ” Checking SSL certificates...$(NC)"
	@if [ -f "./docker/nginx/ssl/cert.pem" ]; then \
		echo "$(GREEN)âœ… Certificate found$(NC)"; \
		echo "Certificate details:"; \
		openssl x509 -in ./docker/nginx/ssl/cert.pem -text -noout | grep -E "(Subject:|Issuer:|Not Before:|Not After:)"; \
		echo ""; \
		echo "Certificate validity:"; \
		openssl x509 -in ./docker/nginx/ssl/cert.pem -checkend 86400 && echo "$(GREEN)âœ… Certificate valid for next 24h$(NC)" || echo "$(YELLOW)âš ï¸ Certificate expires soon$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸ No SSL certificate found$(NC)"; \
		echo "Generate certificates with: make generate-ssl"; \
	fi

generate-ssl: ## Generate SSL certificates for development
	@echo "$(GREEN)ğŸ” Generating SSL certificates...$(NC)"
	@mkdir -p ./docker/nginx/ssl
	@cd ./docker/nginx && ./generate-ssl.sh
	@echo "$(GREEN)âœ… SSL certificates generated$(NC)"

check-ssl-detailed: ## Detailed SSL certificate information
	@echo "$(GREEN)ğŸ” Detailed SSL certificate analysis...$(NC)"
	@if [ -f "./docker/nginx/ssl/cert.pem" ]; then \
		echo ""; \
		echo "$(YELLOW)ğŸ“‹ Full certificate details:$(NC)"; \
		openssl x509 -in ./docker/nginx/ssl/cert.pem -text -noout; \
		echo ""; \
		echo "$(YELLOW)ğŸ”— Certificate fingerprint:$(NC)"; \
		openssl x509 -in ./docker/nginx/ssl/cert.pem -fingerprint -noout; \
		echo ""; \
		echo "$(YELLOW)â° Certificate dates:$(NC)"; \
		openssl x509 -in ./docker/nginx/ssl/cert.pem -dates -noout; \
	else \
		echo "$(RED)âŒ No certificate found$(NC)"; \
	fi

verify-ssl: ## Verify SSL certificate against private key
	@echo "$(GREEN)ï¿½ Verifying SSL certificate and private key...$(NC)"
	@if [ -f "./docker/nginx/ssl/cert.pem" ] && [ -f "./docker/nginx/ssl/key.pem" ]; then \
		cert_hash=$$(openssl x509 -noout -modulus -in ./docker/nginx/ssl/cert.pem | openssl md5); \
		key_hash=$$(openssl rsa -noout -modulus -in ./docker/nginx/ssl/key.pem | openssl md5); \
		if [ "$$cert_hash" = "$$key_hash" ]; then \
			echo "$(GREEN)âœ… Certificate and private key match$(NC)"; \
		else \
			echo "$(RED)âŒ Certificate and private key don't match$(NC)"; \
		fi; \
	else \
		echo "$(RED)âŒ Certificate or private key missing$(NC)"; \
	fi

test-https-simple: ## Test HTTPS connection (simple check)
	@echo "$(GREEN)ğŸ”’ Testing HTTPS connection...$(NC)"
	@curl -k -I https://localhost:3443 2>/dev/null && echo "$(GREEN)âœ… HTTPS working$(NC)" || echo "$(YELLOW)âš ï¸ HTTPS not available$(NC)"

enable-https: ## Enable HTTPS server (project requirement)
	@echo "$(GREEN)ğŸ”’ Starting HTTPS server (project requirement)...$(NC)"
	@chmod +x enable-https.sh
	@./enable-https.sh

security-audit: ## Run security audit
	@echo "$(GREEN)ğŸ” Running security audit...$(NC)"
	@chmod +x tests/security/audit-security.sh
	@./tests/security/audit-security.sh

test-gdpr: ## Test GDPR compliance
	@echo "$(GREEN)ğŸ“‹ Testing GDPR compliance...$(NC)"
	@chmod +x tests/security/test-gdpr-final.sh
	@./tests/security/test-gdpr-final.sh

test-vault: ## Test Vault connectivity and secrets
	@echo "$(GREEN)ğŸ” Testing Vault...$(NC)"
	@chmod +x tests/vault/test-vault-complete.sh
	@./tests/vault/test-vault-complete.sh

test-https: ## Test HTTPS server and security
	@echo "$(GREEN)ğŸ”’ Testing HTTPS...$(NC)"
	@chmod +x tests/security/test-https-complete.sh
	@./tests/security/test-https-complete.sh

test-all: ## Run all security tests (Vault + HTTPS + GDPR + Audit)
	@echo "$(GREEN)ğŸ§ª Running ALL security tests...$(NC)"
	@echo "$(YELLOW)================================$(NC)"
	@$(MAKE) security-audit
	@echo ""
	@$(MAKE) test-vault
	@echo ""
	@$(MAKE) test-https
	@echo ""
	@$(MAKE) test-gdpr
	@echo ""
	@echo "$(GREEN)ğŸ‰ ALL TESTS COMPLETED!$(NC)"

browse-https: ## Open HTTPS site in browser
	@echo "$(GREEN)ğŸŒ Opening HTTPS site...$(NC)"
	@echo "Click the padlock icon (ğŸ”’) in the address bar to see certificate details"
dev: start-dev ## Alias for start-dev

# Default target
all: start-dev
