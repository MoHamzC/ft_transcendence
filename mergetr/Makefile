# Makefile pour ft_transcendence - Gestion des tournois

# Variables
COMPOSE_FILE = compose.yaml
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m

.PHONY: help up down build test-tournament test-tournament-quick test-unit migrate seed status setup

help:
	@echo "$(GREEN)ğŸ¾ ft_transcendence - Commandes de test$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“¦ Docker :$(NC)"
	@echo "  make up              - DÃ©marrer les services"
	@echo "  make down            - ArrÃªter les services"
	@echo "  make build           - Rebuilder les images"
	@echo ""
	@echo "$(YELLOW)ğŸ§ª Tests Tournois :$(NC)"
	@echo "  make test-tournament          - Tests dÃ©taillÃ©s tournois"
	@echo "  make test-tournament-quick    - Tests rapides tournois"
	@echo "  make test-unit               - Tests unitaires"
	@echo ""
	@echo "$(YELLOW)ğŸ—„ï¸  Base de donnÃ©es :$(NC)"
	@echo "  make migrate         - ExÃ©cuter les migrations"
	@echo "  make seed           - InsÃ©rer donnÃ©es de test"
	@echo "  make status         - VÃ©rifier l'Ã©tat des services"
	@echo ""
	@echo "$(YELLOW)ğŸš€ Commandes combinÃ©es :$(NC)"
	@echo "  make setup          - DÃ©marrer + migrer + tester"

# DÃ©marrer les services
up:
	@echo "$(GREEN)ğŸš€ DÃ©marrage des services...$(NC)"
	docker compose -f $(COMPOSE_FILE) up -d --build
	@echo "$(GREEN)âœ… Services dÃ©marrÃ©s !$(NC)"

# ArrÃªter les services
down:
	@echo "$(YELLOW)â¹ï¸  ArrÃªt des services...$(NC)"
	docker compose -f $(COMPOSE_FILE) down

# Rebuilder
build:
	@echo "$(YELLOW)ğŸ”¨ Rebuild des images...$(NC)"
	docker compose -f $(COMPOSE_FILE) build --no-cache

# Migrations
migrate:
	@echo "$(YELLOW)ğŸ—„ï¸  ExÃ©cution des migrations...$(NC)"
	@if [ -f .env ]; then export $$(cat .env | grep -E "^POSTGRES_USER|^POSTGRES_DB" | xargs); fi && \
	docker exec -i mergetr-db-1 psql -U admin -d db_transcendence < backend/database/schema.sql && \
	docker exec -i mergetr-db-1 psql -U admin -d db_transcendence < backend/database/tournament_schema.sql
	@echo "$(GREEN)âœ… Migrations terminÃ©es$(NC)"

# DonnÃ©es de test
seed:
	@echo "$(YELLOW)ğŸŒ± Insertion des donnÃ©es de test...$(NC)"
	docker exec -i mergetr-db-1 psql -U $$POSTGRES_USER -d $$POSTGRES_DB < backend/database/test_data_tournaments.sql
	@echo "$(GREEN)âœ… DonnÃ©es de test insÃ©rÃ©es$(NC)"

# Tests dÃ©taillÃ©s du systÃ¨me de tournois
test-tournament:
	@echo "$(YELLOW)ğŸ† Tests dÃ©taillÃ©s du systÃ¨me de tournois...$(NC)"
	chmod +x backend/tests/test-tournament-detailed.sh
	./backend/tests/test-tournament-detailed.sh

# Tests rapides des tournois
test-tournament-quick:
	@echo "$(YELLOW)ğŸ† Tests rapides des tournois...$(NC)"
	chmod +x backend/tests/test-tournament.sh
	./backend/tests/test-tournament.sh

# Tests unitaires
test-unit:
	@echo "$(YELLOW)ğŸ§ª Tests unitaires...$(NC)"
	docker exec mergetr-backend-1 npm test

# VÃ©rifier que tous les services sont prÃªts
status:
	@echo "$(YELLOW)ğŸ“Š Ã‰tat des services...$(NC)"
	@docker compose ps
	@echo "\n$(YELLOW)ğŸ©º Test de connectivitÃ©...$(NC)"
	@docker exec mergetr-db-1 pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB && echo "$(GREEN)âœ… DB OK$(NC)" || echo "$(RED)âŒ DB KO$(NC)"
	@curl -s http://localhost:5001/health > /dev/null && echo "$(GREEN)âœ… Backend OK$(NC)" || echo "$(RED)âŒ Backend KO$(NC)"
	@curl -s http://localhost:5173 > /dev/null && echo "$(GREEN)âœ… Frontend OK$(NC)" || echo "$(RED)âŒ Frontend KO$(NC)"

# Configuration complÃ¨te en une commande
setup:
	@echo "$(GREEN)ğŸš€ Configuration complÃ¨te du projet...$(NC)"
	$(MAKE) up
	@echo "$(YELLOW)â³ Attente du dÃ©marrage des services (30s)...$(NC)"
	@sleep 30
	$(MAKE) status
	$(MAKE) migrate
	@echo "$(GREEN)ğŸ‰ Projet configurÃ© ! Vous pouvez maintenant lancer les tests.$(NC)"
